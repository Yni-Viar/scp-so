/*
This is a template of a walking NPC without animations, I've made.
Maybe this code isn't very good, this is an example of making NPCs in Godot.
This code was used from unreleased SCP-131 NPC for this game, which later was used from SCP-939 AI from October 2022...
 - Yni

*/

using Godot;
using System;

public partial class scp131npc_b : CharacterBody3D
{
	Node3D target;

	[Export] float speed = 2f;

	public override void _Ready()
	{
	}

    public override void _PhysicsProcess(double delta)
    {
        var state = GetNode<AnimationPlayer>("AnimationPlayer").CurrentAnimation;
        if (target != null)
        {
            SetState("131_Run");
            var direction = GlobalPosition.DirectionTo(target.GlobalPosition);
            Velocity += speed * direction;
            MoveAndSlide();
            this.LookAt(target.GlobalPosition, Vector3.Up);
        }
        else
        {
            SetState("131_Idle");
        }
        
    }

    //Set animation to an entity.
    private void SetState(string s)
    {
        if (GetNode<AnimationPlayer>("AnimationPlayer").CurrentAnimation == s)
        {
            return; //if this animation already applied, then no action.
        }
        //Change the animation.
        GetNode<AnimationPlayer>("AnimationPlayer").Play(s, 0.3d);
    }

    private void OnFindPlayerAreaBodyEntered(Node3D body)
    {
        if (body.IsInGroup("Players"))
        {
            target = body.GetNode<Node3D>("PlayerFeet");
        }
    }


    private void OnFindPlayerAreaBodyExited(Node3D body)
    {
        if (body.IsInGroup("Players"))
        {
            target = null;
        }
    }
}


